
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Consecutive submodeling with MAPDL pool &#8212; PyAnsys Workflows</title>
  
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/ansys-sphinx-theme.css?v=9e79609d" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/ansys-sphinx-theme.css?v=9e79609d" />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.23/css/jquery.dataTables.min.css" />
    <link rel="stylesheet" type="text/css" href="https://www.nerdfonts.com/assets/css/webfont.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />


  <!-- Include desired assets -->
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  

  
    <link href="../../_static/css/breadcrumbs.css" rel="stylesheet" />
  
    <script src="../../_static/documentation_options.js?v=38b66d78"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="https://cdn.datatables.net/1.10.23/js/jquery.dataTables.min.js"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'examples/mapdl-dpf/wf_mapdl-dpf';</script>
    <link rel="icon" href="../../_static/ansys-favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Speos, optiSLang workflow" href="../speos-optislang/index.html" />
    <link rel="prev" title="MAPDL and DPF workflow" href="index.html" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="0.1.0" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  

<a class="navbar-brand logo" href="https://docs.pyansys.com/">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/pyansys_logo_transparent_black.png" class="logo__image only-light" alt="PyAnsys Workflows - Home"/>
    <img src="../../_static/pyansys_logo_transparent_white.png" class="logo__image only-dark pst-js-only" alt="PyAnsys Workflows - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">

<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../index.html" title="PyAnsys Workflows home">Home</a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../getting_started/index.html">
    Getting started
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../../examples.html">
    Workflow examples
  </a>
</li>

  </ul>
</nav>
</div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
      
        <div class="navbar-item">
<div class="search-bar pst-js-only" id="search-bar">
  <form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
    <i class="fa-solid fa-magnifying-glass"></i>
    <input type="search" class="form-control" name="q" placeholder="Search the docs ..."
      aria-label="Search the docs ..." autocomplete="off" autocorrect="off"
      autocapitalize="off" spellcheck="false" />
    <span class="search-button__kbd-shortcut">
      <kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd>
    </span>
  </form>
  <div id="static-search-results" class="static-search-results" style="display:none;" tabindex="0"></div>
</div></div>
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/ansys/pyansys-workflows" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/ansys/pyansys-workflows/discussions" title="Support" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa fa-comment fa-fw fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Support</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  
  


  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">

<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../index.html" title="PyAnsys Workflows home">Home</a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../getting_started/index.html">
    Getting started
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../../examples.html">
    Workflow examples
  </a>
</li>

  </ul>
</nav>
</div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<div class="search-bar pst-js-only" id="search-bar">
  <form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
    <i class="fa-solid fa-magnifying-glass"></i>
    <input type="search" class="form-control" name="q" placeholder="Search the docs ..."
      aria-label="Search the docs ..." autocomplete="off" autocorrect="off"
      autocapitalize="off" spellcheck="false" />
    <span class="search-button__kbd-shortcut">
      <kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd>
    </span>
  </form>
  <div id="static-search-results" class="static-search-results" style="display:none;" tabindex="0"></div>
</div></div>
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/ansys/pyansys-workflows" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/ansys/pyansys-workflows/discussions" title="Support" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa fa-comment fa-fw fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Support</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../fluent-mechanical/index.html">Fluent and mechanical heat transfer workflow for exhaust manifold</a></li>
<li class="toctree-l1"><a class="reference internal" href="../geometry-mesh/index.html">Geometry and meshing workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../geometry-mesh-fluent/index.html">Geometry, meshing and fluids workflow</a></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="index.html">MAPDL and DPF workflow</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Consecutive submodeling with MAPDL pool</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../speos-optislang/index.html">Speos, optiSLang workflow</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">
<nav aria-label="Breadcrumb">
  <ul class="bd-breadcrumbs">
         
    <li class="breadcrumb-item breadcrumb-home">
      <a href="https://docs.pyansys.com/" class="nav-link">PyAnsys</a>
    </li>
     
    <li class="breadcrumb-item">
      <a
        href="../../index.html"
        class="nav-link"
        aria-label="Home"
      >
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
     
    <li class="breadcrumb-item">
      <a href="../../examples.html" class="nav-link">Workflow examples</a>
    </li>
     
    <li class="breadcrumb-item">
      <a href="index.html" class="nav-link">MAPDL and DPF workflow</a>
    </li>
      
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Consecutive submodeling with MAPDL pool</span></li>
    
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-examples-mapdl-dpf-wf-mapdl-dpf-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code.</p>
</div>
<section class="sphx-glr-example-title" id="consecutive-submodeling-with-mapdl-pool">
<span id="ref-mapdl-dpf"></span><span id="sphx-glr-examples-mapdl-dpf-wf-mapdl-dpf-py"></span><h1>Consecutive submodeling with MAPDL pool<a class="headerlink" href="#consecutive-submodeling-with-mapdl-pool" title="Link to this heading">#</a></h1>
<dl class="simple">
<dt>Problem description:</dt><dd><ul class="simple">
<li><p>In this example, we demonstrate how to use MAPDL pool to
perform a consecutive submodeling simulation with MAPDL and DPF.</p></li>
</ul>
</dd>
<dt>Analysis type:</dt><dd><ul class="simple">
<li><p>Static Analysis</p></li>
</ul>
</dd>
<dt>Material properties:</dt><dd><ul class="simple">
<li><p>Young’s modulus, <span class="math notranslate nohighlight">\(E = 200 \, GPa\)</span></p></li>
<li><p>Poisson’s ratio, <span class="math notranslate nohighlight">\(\mu = 0.3\)</span></p></li>
</ul>
</dd>
<dt>Boundary conditions (global model):</dt><dd><ul class="simple">
<li><p>Fixed support applied at the bottom side</p></li>
<li><p>Frictionless support applied at the right side</p></li>
</ul>
</dd>
<dt>Loading:</dt><dd><ul class="simple">
<li><p>Total displacement of -1 mm in the Y-direction at the top surface,
ramped linearly over 10 timesteps</p></li>
</ul>
</dd>
</dl>
<a class="reference internal image-reference" href="examples/_static/bvp.png"><img alt="Problem Sketch" src="examples/_static/bvp.png" style="width: 500px;" />
</a>
<dl class="simple">
<dt>Modeling notes:</dt><dd><ul class="simple">
<li><p>At each timestep, the global model is solved with the specified boundary
conditions; the resulting nodal displacements are interpolated to the
boundary nodes of the local model, using the DPF interpolation operator.
Those displacements are enforced as constraints to the local model,
which is then solved, completing that timestep.</p></li>
</ul>
</dd>
</dl>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">tt</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">ansys.dpf</span><span class="w"> </span><span class="kn">import</span> <span class="n">core</span> <span class="k">as</span> <span class="n">dpf</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ansys.mapdl.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">MapdlPool</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ansys.mapdl.core.examples.downloads</span><span class="w"> </span><span class="kn">import</span> <span class="n">download_example_data</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</pre></div>
</div>
<section id="create-directories-to-save-the-results">
<h2>Create directories to save the results<a class="headerlink" href="#create-directories-to-save-the-results" title="Link to this heading">#</a></h2>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">folders</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;./outputs/mapdl-dpf/global&quot;</span><span class="p">,</span> <span class="s2">&quot;./outputs/mapdl-dpf/local&quot;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">fdr</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">:</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">fdr</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">fdr</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># ##############################################################################</span>
<span class="c1"># Create a pool of MAPDL instances</span>
<span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="c1"># We use the ``MapdlPool`` class to create two separate instances: one dedicated to</span>
<span class="c1"># the global simulation and the other to the local simulation</span>

<span class="n">port_0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;PYMAPDL_PORT_0&quot;</span><span class="p">,</span> <span class="mi">21000</span><span class="p">))</span>
<span class="n">port_1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;PYMAPDL_PORT_1&quot;</span><span class="p">,</span> <span class="mi">21001</span><span class="p">))</span>
<span class="n">is_cicd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;ON_CICD&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">n_cores</span> <span class="o">=</span> <span class="mi">2</span>


<span class="k">if</span> <span class="n">is_cicd</span><span class="p">:</span>
    <span class="n">mapdl_pool</span> <span class="o">=</span> <span class="n">MapdlPool</span><span class="p">(</span>
        <span class="n">port</span><span class="o">=</span><span class="p">[</span><span class="n">port_0</span><span class="p">,</span> <span class="n">port_1</span><span class="p">],</span>
    <span class="p">)</span>

<span class="k">else</span><span class="p">:</span>
    <span class="n">mapdl_pool</span> <span class="o">=</span> <span class="n">MapdlPool</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Creating Pool:   0%|          | 0/2 [00:00&lt;?, ?it/s]/__w/pyansys-workflows/pyansys-workflows/.venv/lib/python3.11/site-packages/ansys/mapdl/core/launcher.py:1741: UserWarning: PyMAPDL couldn&#39;t detect MAPDL version, hence it could not verify that the provided connection mode &#39;grpc&#39; is compatible with the current MAPDL installation.
  warnings.warn(

Creating Pool:  50%|█████     | 1/2 [00:00&lt;00:00,  1.68it/s]
Creating Pool: 100%|██████████| 2/2 [00:00&lt;00:00,  3.05it/s]
Creating Pool: 100%|██████████| 2/2 [00:00&lt;00:00,  2.71it/s]
</pre></div>
</div>
</section>
<section id="connect-to-dpf-server">
<h2>Connect to DPF server<a class="headerlink" href="#connect-to-dpf-server" title="Link to this heading">#</a></h2>
<p>We connect to a local or remote DPF server.
If you are working with a remote server, you might need to upload the <code class="docutils literal notranslate"><span class="pre">RST</span></code>
file before working with it.
Then you can create the <code class="xref py py-class docutils literal notranslate"><span class="pre">DPF</span> <span class="pre">Model</span></code>.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">server_is_local</span> <span class="o">=</span> <span class="s2">&quot;DPF_PORT&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span>

<span class="k">if</span> <span class="n">server_is_local</span><span class="p">:</span>
    <span class="c1"># Local server</span>
    <span class="n">dpf_server</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">start_local_server</span><span class="p">()</span>

<span class="k">else</span><span class="p">:</span>
    <span class="c1"># Remote server</span>
    <span class="n">dpf_server</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">connect_to_server</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;DPF_PORT&quot;</span><span class="p">]))</span>


<span class="c1"># ###############################################################################</span>
<span class="c1"># Set up global and local FE models</span>
<span class="c1"># ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="c1"># We assign the instances to the local and global model, then use</span>
<span class="c1"># ``mapdl.cdread`` to load their geometry and mesh. Note the ``.cdb`` files</span>
<span class="c1"># include named selections for the faces we want to apply the boundary conditions and the loads.</span>
<span class="c1"># The function ``define_bcs`` defines the global model’s boundary conditions and applied loads.</span>
<span class="c1"># The function ``get_boundary`` is used to record the local model’s cut-boundary</span>
<span class="c1"># node coordinates as a ``dpf.Field`` which will be later used in the DPF interpolator input.</span>

<span class="n">cwd</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span>  <span class="c1"># Get current working directory</span>

<span class="c1"># download example data</span>
<span class="n">local_cdb</span> <span class="o">=</span> <span class="n">download_example_data</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;local.cdb&quot;</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="s2">&quot;pyansys-workflow/pymapdl-pydpf&quot;</span><span class="p">)</span>
<span class="n">global_cdb</span> <span class="o">=</span> <span class="n">download_example_data</span><span class="p">(</span>
    <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;global.cdb&quot;</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="s2">&quot;pyansys-workflow/pymapdl-pydpf&quot;</span>
<span class="p">)</span>

<span class="n">mapdl_global</span> <span class="o">=</span> <span class="n">mapdl_pool</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Global model</span>
<span class="n">mapdl_global</span><span class="o">.</span><span class="n">cdread</span><span class="p">(</span><span class="s2">&quot;db&quot;</span><span class="p">,</span> <span class="n">global_cdb</span><span class="p">)</span>  <span class="c1"># Load global model</span>
<span class="n">mapdl_global</span><span class="o">.</span><span class="n">cwd</span><span class="p">(</span><span class="n">cwd</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;outputs/mapdl-dpf/global&quot;</span><span class="p">))</span>  <span class="c1"># Set directory of the global model</span>

<span class="n">mapdl_local</span> <span class="o">=</span> <span class="n">mapdl_pool</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Local model</span>
<span class="n">mapdl_local</span><span class="o">.</span><span class="n">cdread</span><span class="p">(</span><span class="s2">&quot;db&quot;</span><span class="p">,</span> <span class="n">local_cdb</span><span class="p">)</span>  <span class="c1"># Load local model</span>
<span class="n">mapdl_local</span><span class="o">.</span><span class="n">cwd</span><span class="p">(</span><span class="n">cwd</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;outputs/mapdl-dpf/local&quot;</span><span class="p">))</span>  <span class="c1"># Set directory of the local model</span>


<span class="k">def</span><span class="w"> </span><span class="nf">define_bcs</span><span class="p">(</span><span class="n">mapdl</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Define boundary conditions and loading for the global model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mapdl : Mapdl</span>
<span class="sd">        MAPDL instance for the global model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Enter PREP7 in MAPDL</span>
    <span class="n">mapdl</span><span class="o">.</span><span class="n">prep7</span><span class="p">()</span>

    <span class="c1"># In the .cdb file for the global model the bottom, the right and the top faces</span>
    <span class="c1"># are saved as named selections</span>

    <span class="c1"># Fixed support</span>
    <span class="n">mapdl</span><span class="o">.</span><span class="n">cmsel</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;BOTTOM_SIDE&quot;</span><span class="p">,</span> <span class="s2">&quot;NODE&quot;</span><span class="p">)</span>  <span class="c1"># Select bottom face</span>
    <span class="n">mapdl</span><span class="o">.</span><span class="n">d</span><span class="p">(</span><span class="s2">&quot;ALL&quot;</span><span class="p">,</span> <span class="s2">&quot;ALL&quot;</span><span class="p">)</span>
    <span class="n">mapdl</span><span class="o">.</span><span class="n">nsel</span><span class="p">(</span><span class="s2">&quot;ALL&quot;</span><span class="p">)</span>

    <span class="c1"># Frictionless support</span>
    <span class="n">mapdl</span><span class="o">.</span><span class="n">cmsel</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;RIGHT_SIDE&quot;</span><span class="p">,</span> <span class="s2">&quot;NODE&quot;</span><span class="p">)</span>  <span class="c1"># Select right face</span>
    <span class="n">mapdl</span><span class="o">.</span><span class="n">d</span><span class="p">(</span><span class="s2">&quot;ALL&quot;</span><span class="p">,</span> <span class="s2">&quot;UZ&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span>
    <span class="n">mapdl</span><span class="o">.</span><span class="n">nsel</span><span class="p">(</span><span class="s2">&quot;ALL&quot;</span><span class="p">)</span>

    <span class="c1"># Applied load</span>
    <span class="c1"># Ramped Y‑direction displacement of –1 mm is applied on the top face over 10 time steps</span>
    <span class="n">mapdl</span><span class="o">.</span><span class="n">dim</span><span class="p">(</span><span class="s2">&quot;LOAD&quot;</span><span class="p">,</span> <span class="s2">&quot;TABLE&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;TIME&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span>
    <span class="n">mapdl</span><span class="o">.</span><span class="n">taxis</span><span class="p">(</span><span class="s2">&quot;LOAD(1)&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;0.&quot;</span><span class="p">,</span> <span class="s2">&quot;1.&quot;</span><span class="p">,</span> <span class="s2">&quot;10.&quot;</span><span class="p">)</span>
    <span class="n">mapdl</span><span class="o">.</span><span class="n">starset</span><span class="p">(</span><span class="s2">&quot;LOAD(1,1,1)&quot;</span><span class="p">,</span> <span class="s2">&quot;0.&quot;</span><span class="p">)</span>
    <span class="n">mapdl</span><span class="o">.</span><span class="n">starset</span><span class="p">(</span><span class="s2">&quot;LOAD(2,1,1)&quot;</span><span class="p">,</span> <span class="s2">&quot;-0.1&quot;</span><span class="p">)</span>
    <span class="n">mapdl</span><span class="o">.</span><span class="n">starset</span><span class="p">(</span><span class="s2">&quot;LOAD(3,1,1)&quot;</span><span class="p">,</span> <span class="s2">&quot;-1.&quot;</span><span class="p">)</span>

    <span class="n">mapdl</span><span class="o">.</span><span class="n">cmsel</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;TOP_SIDE&quot;</span><span class="p">,</span> <span class="s2">&quot;NODE&quot;</span><span class="p">)</span>  <span class="c1"># Select top face</span>
    <span class="n">mapdl</span><span class="o">.</span><span class="n">d</span><span class="p">(</span><span class="s2">&quot;ALL&quot;</span><span class="p">,</span> <span class="s2">&quot;UY&quot;</span><span class="p">,</span> <span class="s2">&quot;%LOAD%&quot;</span><span class="p">)</span>
    <span class="n">mapdl</span><span class="o">.</span><span class="n">nsel</span><span class="p">(</span><span class="s2">&quot;ALL&quot;</span><span class="p">)</span>

    <span class="c1"># Exit PREP7</span>
    <span class="n">mapdl</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
    <span class="k">pass</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_boundary</span><span class="p">(</span><span class="n">mapdl</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the boundary node coordinates of the local model as a DPF field.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mapdl : Mapdl</span>
<span class="sd">        MAPDL instance for the local model.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dpf.Field</span>
<span class="sd">        DPF field containing the coordinates of the boundary nodes of the local model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Enter PREP7 in MAPDL</span>
    <span class="n">mapdl</span><span class="o">.</span><span class="n">prep7</span><span class="p">()</span>

    <span class="c1"># In the .cdb file for the local model the boundary faces are saved as</span>
    <span class="c1"># named selections</span>

    <span class="n">mapdl</span><span class="o">.</span><span class="n">nsel</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
    <span class="n">nodes</span> <span class="o">=</span> <span class="n">mapdl</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">nodes</span>  <span class="c1"># All nodes</span>
    <span class="n">node_id_all</span> <span class="o">=</span> <span class="n">mapdl</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">nnum</span>  <span class="c1"># All nodes ID</span>
    <span class="n">mapdl</span><span class="o">.</span><span class="n">cmsel</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;boundary&quot;</span><span class="p">,</span> <span class="s2">&quot;NODE&quot;</span><span class="p">)</span>  <span class="c1"># Select all boundary faces</span>
    <span class="n">node_id_subset</span> <span class="o">=</span> <span class="n">mapdl</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span><span class="s2">&quot;NODE&quot;</span><span class="p">,</span> <span class="n">item1</span><span class="o">=</span><span class="s2">&quot;NLIST&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>  <span class="c1"># Boundary nodes ID</span>
    <span class="n">map_</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">node_id_all</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">node_id_all</span><span class="p">)))))</span>

    <span class="n">mapdl</span><span class="o">.</span><span class="n">nsel</span><span class="p">(</span><span class="s2">&quot;NONE&quot;</span><span class="p">)</span>
    <span class="n">boundary_coordinates</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">fields_factory</span><span class="o">.</span><span class="n">create_3d_vector_field</span><span class="p">(</span>
        <span class="n">num_entities</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">node_id_subset</span><span class="p">),</span> <span class="n">location</span><span class="o">=</span><span class="s2">&quot;Nodal&quot;</span>
    <span class="p">)</span>  <span class="c1"># Define DPF field for DPF interpolator input</span>

    <span class="n">nsel</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">node_id_subset</span><span class="p">:</span>  <span class="c1"># Iterate boundary nodes of the local model</span>
        <span class="n">nsel</span> <span class="o">+=</span> <span class="s2">&quot;nsel,A,NODE,,</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">nid</span>
        <span class="p">)</span>  <span class="c1"># Add selection command for the node to the str (only for ploting)</span>
        <span class="n">boundary_coordinates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="n">map_</span><span class="p">[</span><span class="n">nid</span><span class="p">]],</span> <span class="n">nid</span><span class="p">)</span>  <span class="c1"># Add node to the DPF field</span>

    <span class="c1"># Select all boundary nodes (only for ploting)</span>
    <span class="n">mapdl</span><span class="o">.</span><span class="n">input_strings</span><span class="p">(</span><span class="n">nsel</span><span class="p">)</span>

    <span class="c1"># Plot boundary nodes of the local model</span>
    <span class="n">mapdl</span><span class="o">.</span><span class="n">nplot</span><span class="p">(</span><span class="n">background</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">show_bounds</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Constrained nodes&quot;</span><span class="p">)</span>

    <span class="c1"># Exit PREP7</span>
    <span class="n">mapdl</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">boundary_coordinates</span>


<span class="c1"># Define the boundary conditions and the loading for the global model</span>
<span class="n">define_bcs</span><span class="p">(</span><span class="n">mapdl_global</span><span class="p">)</span>

<span class="c1"># Get the DPF field with the boundary nodes of the local model</span>
<span class="n">boundary_coords</span> <span class="o">=</span> <span class="n">get_boundary</span><span class="p">(</span><span class="n">mapdl_local</span><span class="p">)</span>
</pre></div>
</div>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-0" name="sd-tab-set-0" type="radio">
<label class="sd-tab-label" for="sd-tab-item-0">
Static Scene</label><div class="sd-tab-content docutils">
<img src="../../_images/sphx_glr_wf_mapdl-dpf_001.png" srcset="../../_images/sphx_glr_wf_mapdl-dpf_001.png" alt="wf mapdl dpf" class = "sphx-glr-single-img"/></div>
<input id="sd-tab-item-1" name="sd-tab-set-0" type="radio">
<label class="sd-tab-label" for="sd-tab-item-1">
Interactive Scene</label><div class="sd-tab-content docutils">
</div>
</div>
</section>
<section id="set-up-dpf-operators">
<h2>Set up DPF operators<a class="headerlink" href="#set-up-dpf-operators" title="Link to this heading">#</a></h2>
<p>We define two DPF operators: the first reads the displacement results from the global model,
and the second interpolates those displacements onto the boundary coordinates of the local
model. The <code class="docutils literal notranslate"><span class="pre">DataSources</span></code> class to link results with the DPF operator inputs.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">define_dpf_operators</span><span class="p">(</span><span class="n">n_cores</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Define DPF operators for the global model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n_cores : int</span>
<span class="sd">        Number of cores used in the global model.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dpf.Model</span>
<span class="sd">        DPF model for the global model.</span>
<span class="sd">    dpf.Operator</span>
<span class="sd">        DPF operator to read nodal displacements from the global model.</span>
<span class="sd">    dpf.Operator</span>
<span class="sd">        DPF operator to interpolate displacements onto local model boundary coordinates.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Define the DataSources class and link it to the results of the global model</span>
    <span class="n">data_sources</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">DataSources</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cores</span><span class="p">):</span>
        <span class="n">data_sources</span><span class="o">.</span><span class="n">set_domain_result_file_path</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;./outputs/mapdl-dpf/global/file</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.rst&quot;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;rst&quot;</span><span class="p">,</span> <span class="n">domain_id</span><span class="o">=</span><span class="n">i</span>
        <span class="p">)</span>

    <span class="n">global_model</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">data_sources</span><span class="p">)</span>
    <span class="c1"># Define displacement result operator to read nodal displacements</span>
    <span class="n">global_disp_op</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">operators</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">displacement</span><span class="p">()</span>
    <span class="c1"># Connect displacement result operator with the global model&#39;s results file</span>
    <span class="n">global_disp_op</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">data_sources</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">data_sources</span><span class="p">)</span>
    <span class="c1"># Define interpolator to interpolate the results inside the mesh elements</span>
    <span class="c1"># with shape functions</span>
    <span class="n">disp_interpolator</span> <span class="o">=</span> <span class="n">dpf</span><span class="o">.</span><span class="n">operators</span><span class="o">.</span><span class="n">mapping</span><span class="o">.</span><span class="n">on_coordinates</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">global_model</span><span class="p">,</span> <span class="n">global_disp_op</span><span class="p">,</span> <span class="n">disp_interpolator</span>


<span class="k">def</span><span class="w"> </span><span class="nf">initialize_dpf_interpolator</span><span class="p">(</span>
    <span class="n">global_model</span><span class="p">,</span>
    <span class="n">local_bc_coords</span><span class="p">,</span>
    <span class="n">disp_interpolator</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the DPF interpolator for the local model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    global_model : dpf.Model</span>
<span class="sd">        DPF model for the global model.</span>
<span class="sd">    local_bc_coords : dpf.Field</span>
<span class="sd">        DPF field containing the coordinates of the boundary nodes of the local model.</span>
<span class="sd">    disp_interpolator : dpf.Operator</span>
<span class="sd">        DPF operator to interpolate displacements onto local model boundary coordinates.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">my_mesh</span> <span class="o">=</span> <span class="n">global_model</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">meshed_region</span>  <span class="c1"># Global model&#39;s mesh</span>
    <span class="n">disp_interpolator</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">coordinates</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
        <span class="n">local_bc_coords</span>
    <span class="p">)</span>  <span class="c1"># Link interpolator inputs with the local model&#39;s boundary coordinates</span>
    <span class="n">disp_interpolator</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
        <span class="n">my_mesh</span>
    <span class="p">)</span>  <span class="c1"># Link interpolator mesh with the global model&#39;s mesh</span>


<span class="k">def</span><span class="w"> </span><span class="nf">interpolate_data</span><span class="p">(</span><span class="n">timestep</span><span class="p">):</span>
    <span class="n">global_disp_op</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">time_scoping</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
        <span class="p">[</span><span class="n">timestep</span><span class="p">]</span>
    <span class="p">)</span>  <span class="c1"># Specify timestep value to read results from</span>
    <span class="n">global_disp</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">global_disp_op</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">fields_container</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
    <span class="p">)</span>  <span class="c1"># Read global nodal displacements</span>

    <span class="n">disp_interpolator</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">fields_container</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
        <span class="n">global_disp</span>
    <span class="p">)</span>  <span class="c1"># Link the interpolation data with the interpolator</span>
    <span class="n">local_disp</span> <span class="o">=</span> <span class="n">disp_interpolator</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">fields_container</span><span class="o">.</span><span class="n">get_data</span><span class="p">()[</span>
        <span class="mi">0</span>
    <span class="p">]</span>  <span class="c1"># Get displacements of the boundary nodes of the local model</span>
    <span class="k">return</span> <span class="n">local_disp</span>


<span class="c1"># Define the two DPF operators</span>
<span class="n">global_model</span><span class="p">,</span> <span class="n">global_disp_op</span><span class="p">,</span> <span class="n">disp_interpolator</span> <span class="o">=</span> <span class="n">define_dpf_operators</span><span class="p">(</span><span class="n">n_cores</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="set-up-simulation-loop">
<h2>Set up simulation loop<a class="headerlink" href="#set-up-simulation-loop" title="Link to this heading">#</a></h2>
<p>We solve the two models sequentially for each loading step.
First the global model is run producing a .rst results file.
Then we extract the global displacements and use them to define
cut-boundary conditions for the local model
(an input string command will be used for faster excecution time).</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">define_cut_boundary_constraint_template</span><span class="p">(</span><span class="n">local_bc_coords</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Define template of input string command to apply the displacement constraints.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    local_bc_coords : dpf.Field</span>
<span class="sd">        DPF field containing the coordinates of the boundary nodes of the local model.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Template of input string command to apply the displacement constraints.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Define template of input string command to apply the displacement constraints</span>
    <span class="n">local_nids</span> <span class="o">=</span> <span class="n">local_bc_coords</span><span class="o">.</span><span class="n">scoping</span><span class="o">.</span><span class="n">ids</span>
    <span class="c1"># Get Node ID of boundary nodes of the local model</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">local_nids</span><span class="p">:</span>
        <span class="n">template</span> <span class="o">+=</span> <span class="p">(</span>
            <span class="s2">&quot;d,&quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;,ux,</span><span class="si">{:1.6e}</span><span class="se">\n</span><span class="s2">d,&quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;,uy,</span><span class="si">{:1.6e}</span><span class="se">\n</span><span class="s2">d,&quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;,uz,</span><span class="si">{:1.6e}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">template</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_global_local</span><span class="p">(</span><span class="n">mapdl_global</span><span class="p">,</span> <span class="n">mapdl_local</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">,</span> <span class="n">local_bc_coords</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Solve the global and local models sequentially for each timestep.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mapdl_global : Mapdl</span>
<span class="sd">        MAPDL instance for the global model.</span>
<span class="sd">    mapdl_local : Mapdl</span>
<span class="sd">        MAPDL instance for the local model.</span>
<span class="sd">    timesteps : int</span>
<span class="sd">        Number of timesteps to solve.</span>
<span class="sd">    local_bc_coords : dpf.Field</span>
<span class="sd">        DPF field containing the coordinates of the boundary nodes of the local model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Enter solution processor</span>
    <span class="n">mapdl_global</span><span class="o">.</span><span class="n">solution</span><span class="p">()</span>
    <span class="n">mapdl_local</span><span class="o">.</span><span class="n">solution</span><span class="p">()</span>

    <span class="c1"># Static analysis</span>
    <span class="n">mapdl_global</span><span class="o">.</span><span class="n">antype</span><span class="p">(</span><span class="s2">&quot;STATIC&quot;</span><span class="p">)</span>
    <span class="n">mapdl_local</span><span class="o">.</span><span class="n">antype</span><span class="p">(</span><span class="s2">&quot;STATIC&quot;</span><span class="p">)</span>

    <span class="n">constraint_template</span> <span class="o">=</span> <span class="n">define_cut_boundary_constraint_template</span><span class="p">(</span><span class="n">local_bc_coords</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># Iterate timesteps</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Timestep: </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1"># Set loadstep time for the global model</span>
        <span class="n">mapdl_global</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="c1"># No extrapolation</span>
        <span class="n">mapdl_global</span><span class="o">.</span><span class="n">eresx</span><span class="p">(</span><span class="s2">&quot;NO&quot;</span><span class="p">)</span>
        <span class="n">mapdl_global</span><span class="o">.</span><span class="n">allsel</span><span class="p">(</span><span class="s2">&quot;ALL&quot;</span><span class="p">)</span>
        <span class="c1"># Write ALL results to database</span>
        <span class="n">mapdl_global</span><span class="o">.</span><span class="n">outres</span><span class="p">(</span><span class="s2">&quot;ALL&quot;</span><span class="p">,</span> <span class="s2">&quot;ALL&quot;</span><span class="p">)</span>
        <span class="c1"># Solve global model</span>
        <span class="n">mapdl_global</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Global solve took &quot;</span><span class="p">,</span> <span class="n">tt</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">st</span><span class="p">)</span>

        <span class="c1"># Initialize interpolator</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">initialize_dpf_interpolator</span><span class="p">(</span><span class="n">global_model</span><span class="p">,</span> <span class="n">local_bc_coords</span><span class="p">,</span> <span class="n">disp_interpolator</span><span class="p">)</span>
        <span class="c1"># Read  &amp; Interpolate displacement data</span>
        <span class="n">local_disp</span> <span class="o">=</span> <span class="n">interpolate_data</span><span class="p">(</span><span class="n">timestep</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
        <span class="c1"># Run MAPDL input string command to apply the displacement constraints</span>
        <span class="n">data_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">local_disp</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">mapdl_local</span><span class="o">.</span><span class="n">input_strings</span><span class="p">(</span><span class="n">constraint_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">data_array</span><span class="p">))</span>

        <span class="n">st</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">mapdl_local</span><span class="o">.</span><span class="n">allsel</span><span class="p">(</span><span class="s2">&quot;ALL&quot;</span><span class="p">)</span>
        <span class="c1"># Set loadstep time for the local model</span>
        <span class="n">mapdl_local</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="c1"># No extrapolation</span>
        <span class="n">mapdl_local</span><span class="o">.</span><span class="n">eresx</span><span class="p">(</span><span class="s2">&quot;NO&quot;</span><span class="p">)</span>
        <span class="c1"># Write ALL results to database</span>
        <span class="n">mapdl_local</span><span class="o">.</span><span class="n">outres</span><span class="p">(</span><span class="s2">&quot;ALL&quot;</span><span class="p">,</span> <span class="s2">&quot;ALL&quot;</span><span class="p">)</span>
        <span class="c1"># Solve local model</span>
        <span class="n">mapdl_local</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Local solve took &quot;</span><span class="p">,</span> <span class="n">tt</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">st</span><span class="p">)</span>

    <span class="c1"># Exit solution processor</span>
    <span class="n">mapdl_global</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
    <span class="n">mapdl_local</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="solve-system">
<h2>Solve system<a class="headerlink" href="#solve-system" title="Link to this heading">#</a></h2>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">n_steps</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># Number of timesteps</span>
<span class="n">solve_global_local</span><span class="p">(</span><span class="n">mapdl_global</span><span class="p">,</span> <span class="n">mapdl_local</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">,</span> <span class="n">boundary_coords</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Timestep: 1
Global solve took  0.295900821685791
Local solve took  0.6045112609863281
Timestep: 2
Global solve took  0.314166784286499
Local solve took  0.4857981204986572
Timestep: 3
Global solve took  0.29784679412841797
Local solve took  0.48508429527282715
Timestep: 4
Global solve took  0.2530813217163086
Local solve took  0.48616886138916016
Timestep: 5
Global solve took  0.29834961891174316
Local solve took  0.5269887447357178
Timestep: 6
Global solve took  0.28623247146606445
Local solve took  0.5217921733856201
Timestep: 7
Global solve took  0.2713959217071533
Local solve took  0.5231709480285645
Timestep: 8
Global solve took  0.25833964347839355
Local solve took  0.48531007766723633
Timestep: 9
Global solve took  0.30339646339416504
Local solve took  0.5247218608856201
Timestep: 10
Global solve took  0.2921884059906006
Local solve took  0.48586559295654297
</pre></div>
</div>
</section>
<section id="visualize-results">
<h2>Visualize results<a class="headerlink" href="#visualize-results" title="Link to this heading">#</a></h2>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">visualize</span><span class="p">(</span><span class="n">mapdl</span><span class="p">):</span>
    <span class="c1"># Enter post-processing</span>
    <span class="n">mapdl</span><span class="o">.</span><span class="n">post1</span><span class="p">()</span>
    <span class="c1"># Set the current results set to the last set to be read from result file</span>
    <span class="n">mapdl</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;LAST&quot;</span><span class="p">)</span>
    <span class="c1"># Plot nodal displacement of the loading direction</span>
    <span class="n">mapdl</span><span class="o">.</span><span class="n">post_processing</span><span class="o">.</span><span class="n">plot_nodal_displacement</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;jet&quot;</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">cpos</span><span class="o">=</span><span class="s2">&quot;zy&quot;</span><span class="p">)</span>
    <span class="c1"># Exit post-processing</span>
    <span class="n">mapdl</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>


<span class="c1"># Plot Y displacement of global model</span>
<span class="n">visualize</span><span class="p">(</span><span class="n">mapdl_global</span><span class="p">)</span>

<span class="c1"># Plot Y displacement of local model</span>
<span class="n">visualize</span><span class="p">(</span><span class="n">mapdl_local</span><span class="p">)</span>
</pre></div>
</div>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-2" name="sd-tab-set-1" type="radio">
<label class="sd-tab-label" for="sd-tab-item-2">
Static Scene</label><div class="sd-tab-content docutils">
<img src="../../_images/sphx_glr_wf_mapdl-dpf_002.png" srcset="../../_images/sphx_glr_wf_mapdl-dpf_002.png" alt="wf mapdl dpf" class = "sphx-glr-single-img"/></div>
<input id="sd-tab-item-3" name="sd-tab-set-1" type="radio">
<label class="sd-tab-label" for="sd-tab-item-3">
Interactive Scene</label><div class="sd-tab-content docutils">
</div>
</div>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-4" name="sd-tab-set-2" type="radio">
<label class="sd-tab-label" for="sd-tab-item-4">
Static Scene</label><div class="sd-tab-content docutils">
<img src="../../_images/sphx_glr_wf_mapdl-dpf_003.png" srcset="../../_images/sphx_glr_wf_mapdl-dpf_003.png" alt="wf mapdl dpf" class = "sphx-glr-single-img"/></div>
<input id="sd-tab-item-5" name="sd-tab-set-2" type="radio">
<label class="sd-tab-label" for="sd-tab-item-5">
Interactive Scene</label><div class="sd-tab-content docutils">
</div>
</div>
</section>
<section id="exit-mapdl-instances">
<h2>Exit MAPDL instances<a class="headerlink" href="#exit-mapdl-instances" title="Link to this heading">#</a></h2>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">mapdl_pool</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
</pre></div>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> (0 minutes 19.513 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-examples-mapdl-dpf-wf-mapdl-dpf-py">
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/be5a470dca4191aea31b569def103b2d/wf_mapdl-dpf.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">wf_mapdl-dpf.ipynb</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/a7122136b4916fac5100dc5044302ecf/wf_mapdl-dpf.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">wf_mapdl-dpf.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-zip docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/5985d6703c9ea3dd9db1d8222a6b373b/wf_mapdl-dpf.zip"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">zipped:</span> <span class="pre">wf_mapdl-dpf.zip</span></code></a></p>
</div>
</div>
</section>
</section>


                </article>
              
              
              
              
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-directories-to-save-the-results">Create directories to save the results</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#connect-to-dpf-server">Connect to DPF server</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-up-dpf-operators">Set up DPF operators</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-up-simulation-loop">Set up simulation loop</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#solve-system">Solve system</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-results">Visualize results</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exit-mapdl-instances">Exit MAPDL instances</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">
<!-- If there is no fix edit button function, use the PyData edit-this-button-->
</div>

  <div class="sidebar-secondary-item">
  <div role="note" aria-label="source link">
    <ul class="this-page-menu">
      <li><a href="../../_sources/examples/mapdl-dpf/wf_mapdl-dpf.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>


  <!-- Include desired assets -->
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.7/require.min.js"></script>

<script>
// Passing the search options to the search.js file
const SEARCH_OPTIONS = JSON.parse('{"keys": ["title", "text", "objectID"], "limit": 10, "threshold": 0.2}');
const SEARCH_FILE = "../../_static/search.json";
const ADVANCE_SEARCH_PATH = "../../search.html";
const EXTRA_SOURCES = JSON.parse('""');
</script>


<script src="../../_static/js/search.js"></script>

  
  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright (c) 2025 ANSYS, Inc. All rights reserved.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item"><p class="theme-version">
  Built with the
  <a href="https://sphinxdocs.ansys.com/version/stable/index.html"
    >Ansys Sphinx Theme</a
  >
  1.6.3. <br />Last updated on
  <span id="ast_build_date"></span>
</p>
<script>
  var options = { day: "numeric", month: "long", year: "numeric" };
  var ast_lastModifiedDate = new Date(document.lastModified);
  var ast_build_date = ast_lastModifiedDate.toLocaleDateString("en-US", options);
  document.getElementById("ast_build_date").innerHTML = ast_build_date;
</script></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>